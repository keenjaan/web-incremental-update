<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
	<!-- <link rel="stylesheet" href="/css/app.e040231b4c18b66b6bd7fef0d1036fd5.css" /> -->
	<!-- <script src="/diff.js"></script> -->
	<script>
		var version = '0.0.2';
		var resource = [
			{
				name: 'js/manifest',
				hash: '09870d820b825613b221',
				isDownload: false,
				isExe: false
			},
			{
				name: 'js/vendor',
				hash: '81d6d64af49feb826eaf',
				isDownload: false,
				isExe: false
			},
			{
				name: 'js/app',
				hash: 'fbe675461aa62374f885',
				isDownload: false,
				isExe: false
			},
			{
				name: 'css/app',
				hash: 'e040231b4c18b66b6bd7fef0d1036fd5'
			}
		]
	</script>
</head>
<body>
	<div id="app"></div>
	<script>
		init();
		function ajax(name, oldHash, hash, callback) {
			var url = name;
			url = url + '?hash=' + (hash || '') + '&oldHash=' + (oldHash || '');
			var xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function () {
				if (xhr.readyState === 4) {
					if (xhr.status === 200) {
						if (callback) {
							callback(hash, name, xhr.responseText)
						}
					} else {
						throw new Error('服务器挂了')
					}
				}
			}
			xhr.open('GET', url, true);
    		xhr.send();
		}
		// 匹配版本号
		function isMatchStorage(name, hash) {
			var store = getStorageOb(name);
			if (store) {
				if (store.hash === hash) {
					return {status: 'cache', hash}
				} else {
					return {status: 'merge', hash: store.hash}
				}
			}
			return {status: 'no-cache', hash: null}
		}
		// 初始化
		function init() {
			for (var i = 0; i < resource.length; i++) {
				var fileName = resource[i].name;
				var hash = resource[i].hash;
				var version = window.localStorage.getItem('version');
				// debugger;
				if (version) {
					var ob = isMatchStorage(fileName, hash);
					switch (ob.status) {
						case 'cache':
							loadFile(ob.hash, fileName);
							break;
						case 'merge':
							fetchFile(fileName, ob.hash, hash);
							break;
						default:
							fetchFile( fileName, ob.hash, hash)
					}
				} else {
					// 调用接口拉取文件
					fetchFile( fileName, null, hash)
				}
			}
		}
		// 加载本地缓存
		function loadFile(hash, name) {
			var type = fileNameToType(name);
			var fileStr = getStorageOb(name);
			modifyStatus(name, fileStr.str)
			// 文件存在
			if (fileStr) {
				if (type === 'css') {
					// 执行css
					loadCss(fileStr.str)
				} else if (type === 'js') {
					//执行js
					try {
						judgeExe(name)
						// eval(fileStr.str)
					} catch(err) {
						fetchFile(name, null, hash)
					}
					
				}
			} else {
				// 文件不存在
				fetchFile(name, null, hash)
			}
		}

		// 加载css文件
		function loadCss(str) {
			var style = document.createElement('style');
			style.rel = "stylesheet"
			// rel="stylesheet"
			var head = document.querySelector('head');
			style.innerHTML = str;
			head.appendChild(style);
		}
		// 调用接口
		function fetchFile(name, oldHash, hash) {
			ajax(name, oldHash, hash, cb);
		}
		// 接口回调函数
		function cb(hash, name, data) {
			// 正常返回
			var dataOb = JSON.parse(data)
			if (dataOb.isMerge) {
				// 合并代码
				mergeVersion(name, hash, dataOb.data)
			} else {
				saveExe(name, hash, dataOb.data)
			}
		}

		function mergeVersion(name, hash, data) {
			// 合并代码
			var versionOb = getStorageOb(name);
			var oldVersion = versionOb ? versionOb.str : '';
			var newVersion = JsDiff.applyPatch(oldVersion, data)
			saveExe(name, hash, newVersion)
		}

		// 新代码存到本地并执行相关代码
		function saveExe(name, hash, data) {
			modifyStatus(name, data)
			// 存新版本
			var obj = {
				hash,
				str: data
			}
			window.localStorage.setItem(name, JSON.stringify(obj))
			window.localStorage.setItem('version', version)
			// 判断文件类型
			var type = fileNameToType(name);
			if (type === 'css') {
				// 执行css
				loadCss(data)
			} else if (type === 'js') {
				//执行js
				judgeExe(name)
				// console.log(data, 'data')
				// eval(data)
			}
		}
		// 判断是否能执行js
		
		 function judgeExe (name) {
			var index;
			for (var i = 0; i < resource.length; i++) {
				if (resource[i].name === name) {
					index = i;
					break;
				}
			}
			// 遍历当前js文件之前的文件，如果之前的js文件有没有成功返回的，就不能执行当前文件
			var canExe = true;
			for (var j = 0; j <= index; j++) {
				if (!resource[j].isDownload) {
					canExe = false;
					break;
				}
			}
			// 如果有可以执行
			if (canExe) {
				console.log(index, 'exe index')
				exeEval(resource[index].src)
				// window.eval(resource[index].src);
				for (var k = index + 1; k < resource.length; k++) {
					if (resource[k].isDownload) {
						console.log(k, 'exe for key')
						exeEval(resource[k].src)
						// window.eval(resource[k].src)
					} else {
						break;
					}
				}
			}
		}

		// 执行eval函数
		function exeEval(str) {
			window.eval(str)
		}

		// 从资源配置数组里匹配当前文件，改变配置状态
		function modifyStatus(name, data) {
			for (var i = 0; i < resource.length; i++) {
				if (resource[i].name === name) {
					resource[i].src = data;
					resource[i].isDownload = true;
					break;
				}
			}
		}
		// 从资源配置数组里读取文件，改变执行状态
		function modifyExt(name) {
			for (var i = 0; i < resource.length; i++) {
				if (resource[i].name === name) {
					resource[i].isExe = true;
					break;
				}
			}
		}
		// 从localStorage中获取json对象并解析，如果取不到则返回null
		function getStorageOb(key) {
			var value = window.localStorage.getItem(key);
			if (value) {
				try {
					var data = JSON.parse(value);
					return data
				} catch(err) {
					return null
				}
			}
			return null
		}
		// 根据文件名判断文件类型
		function fileNameToType(name) {
			// 这里只有js，css两种类型
			var reg = /^js.*/ig;
			if (reg.test(name)) {
				return 'js'
			} else {
				return 'css'
			}
		}

	</script>
</body>
</html>